<html>
    <head>
        <title>DataFlow</title>
		<meta charset='utf-8'>
		<meta http-equiv="X-UA-Compatible" content="chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link href='/static/css/custom.css' rel='stylesheet' type='text/css'>
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
        <link rel="stylesheet" type="text/css" href="/static/css/jquery.flowchart.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <script src='/static/js/jquery.flowchart.min.js'></script>
        <style>
        .BoxDD .flowchart-operator-title {background-color: orange;}
        .BoxSource .flowchart-operator-title {background-color: lightgreen;}
        .BoxDE .flowchart-operator-title {background-color: lightblue;}
        #codepen {width: 100%; }
        </style>
    </head>
    <body>
        <nav class='navbar navbar-default'>
            <div class='container-fluid'>
                <div class="navbar-header">
                    <a class="navbar-brand" href="/">DataFlow</a>
                </div>
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/">Home</a></li>
                    <li><a href="/scripts/">Scripts</a></li>
                </ul>
            </div>
        </nav>
        <div class='container text-center'>
            <hr>
            <div class='row'>
                <table class='col-md-12'>
                    <tbody>
                        <tr><td class='col-md-2'>Code For: </td><td class='col-md-10'><textarea  id='codepen'></textarea></td></tr>
                    </tbody>
                </table>
            </div>
            <hr>
            <div class='row text-left'>
                <div class='col-md-2 column'>
                    <ul class="nav nav-pills nav-stacked">
                        <li><button class='btn btn-success'><span class="glyphicon glyphicon-chevron-right"></span>read_csv</button></li>
                        <li><button class='btn btn-success'><span class="glyphicon glyphicon-chevron-right"></span>RandomForestClassifier</button></li>
                        <li><button class='btn btn-info'><span class="glyphicon glyphicon-chevron-right"></span>CrossValidate</button></li>
                    </ul>
                </div>

                <div class='col-md-10'>
                    <div id='example_multiple' class="flowchart-example-container"></div>
                </div>
            </div>
            <div>
                <p>The letters in brackets indicate the keys you can press to perform the functions. You can also click the buttons themselves.</p>
                <button id='addDD' class='btn'>Add [D]ata to Data Box</button>
                <button id='addSource' class='create_operator btn'>Add [S]ource Box</button>
                <button id='addDE' class='create_operator btn'>Add Data and [E]stimator Box</button>
                <button id='MAKESCRIPT' class='btn'>[M]ake Py Script!</button>

            </div>

        <script>
     $(document).ready(function() {
         var boxcount=0;
         $("#addDD").click(function (){
              var operatorId = 'Data_Data'+ boxcount;
              var operatorData = {
                top: 0, left: 0,
                properties: {
                  title: operatorId,
                  inputs: {input_1: {label: 'inp1'}, input_2:{label: 'inp2'}, input_3:{label: 'inp3'}},
                  outputs: {output_1: {label: 'out1'}, output_2:{label: 'out2'}, output_3:{label: 'out3'}},
                  multiple: true,
                  class: 'BoxDD'
                }
              };
              boxcount += 1;
              $flowchart.flowchart('createOperator', operatorId, operatorData);
         });
         $("#addSource").click(function (){
              var operatorId = 'Source'+ boxcount;
              var name = prompt("Please name this source:", defaultText=operatorId);
              var operatorData = {
                top: 0, left: 0,
                properties: {
                  title: name,
                  inputs: {},
                  outputs: {output_1: {label: 'out1'}, output_2:{label: 'out2'}, output_3:{label: 'out3'}},
                  class: 'BoxSource',
                }
              };
              boxcount += 1;
              $flowchart.flowchart('createOperator', operatorId, operatorData);
         });
         $("#addDE").click(function (){
              var operatorId = 'Data-Estimator' + boxcount;
              var operatorData = {
                top: 0, left: 0,
                properties: {
                  title: operatorId,
                  inputs: {input_1: {label: 'est1'}, input_2:{label: 'data1'}},
                  outputs: {output_1: {label: 'est1_out'}, output_2:{label: 'data1_out'}},
                  class: 'BoxDE',
                }
              };
              boxcount += 1;
              $flowchart.flowchart('createOperator', operatorId, operatorData);
         });


        var data = { operators: {}, links: {}};
        var $flowchart=$("#example_multiple");
        var $container =$flowchart.parent();
        $("#codepen").change(function (){
              var opid = $flowchart.flowchart('getSelectedOperatorId');
              console.log(opid);
              var data = $flowchart.flowchart('getOperatorData', opid);
              data['program'] = $("#codepen").val();
              $flowchart.flowchart('setOperatorData', opid, data);
              console.log(data['program']);
        });

        $flowchart.flowchart({
          data: data,
          linkWidth:5,
          multipleLinksOnOutput: true,
          grid:10,
          onOperatorSelect: function (operatorID){
              $("#codepenlabel").text(operatorID);
              var data = $flowchart.flowchart('getOperatorData', operatorID);
              console.log(data['program']);
              if (data['program']) {
                  $("#codepen").val(data['program']);
                } else {
                  $("#codepen").val("");
                }
              return true;
          },

        });
        $(document).keypress(function(e) {
            if ($("#codepen").is(":focus")) {console.log("I do not know how to do NOT");}
            else{
                switch (e.which) {
                    case 120: 
                    case 127:
                         $flowchart.flowchart('deleteSelected'); break;
                    case 115:
                         $("#addSource").click(); break;
                    case 100:
                         $("#addDD").click(); break;
                    case 101:
                         $("#addDE").click(); break;
                    case 109:
                         $("#MAKESCRIPT").click(); break;
                    default:
                         console.log(e.which);
                };
            }
        });

         $("#MAKESCRIPT").click(function (){
             var data = $flowchart.flowchart('getData');
             data['scriptname'] = prompt("Enter the script name: ", defaultText="script");
             console.log(data);
             $.ajax({
                 'type': 'POST',
                 'url': '/makescript',
                 'contentType': 'application/json',
                 'data': JSON.stringify(data),
                 'dataType': 'json',
                 'success': console.log});
         });
          });  // document ready
    </script>
    <hr>
    <a href='/scripts/'>View scripts</a>
    </div>
    </body>
</html>
